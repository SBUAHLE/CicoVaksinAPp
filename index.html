
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CICO Vaksinasi</title>
  <style>
    /* ===== PALET WARNA SOFT ===== */
    :root{
      --bg: #f5f7ff;          /* pastel blue bg */
      --card:#ffffff;         /* kartu putih   */
      --line:#e6ecff;         /* border lembut */
      --primary:#4f46e5;      /* indigo lembut */
      --primary-weak:#eef2ff; /* indigo sangat lembut */
      --text:#1f2937;         /* abu tua */
      --muted:#6b7280;        /* abu */
      --ok:#059669;           /* hijau */
      --warn:#b45309;         /* amber */
      --danger:#ef4444;       /* merah */
    }

    /* ===== GLOBAL ===== */
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;font-size:17px;}
    .container{max-width:820px;margin:28px auto;padding:0 18px;}

    h1{font-size:26px;margin:0 0 10px 0;}
    h2{font-size:22px;margin:0 0 10px 0;}
    p.note{color:var(--muted);margin:4px 0 16px 0;}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px;margin-bottom:16px;
      box-shadow:0 2px 6px rgba(31,41,55,.05);}

    label{display:block;font-weight:600;margin:10px 0 6px;}
    input[type=text],input[type=number],textarea,select{
      width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:17px;
    }
    input[readonly]{background:#f8f9ff}
    textarea{min-height:100px}

    .btn{display:inline-block;padding:12px 16px;border:0;border-radius:12px;cursor:pointer;font-weight:600;font-size:17px}
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-ghost{background:var(--primary-weak);color:var(--text);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-link{background:transparent;color:var(--primary);text-decoration:underline;cursor:pointer;border:0;padding:0;}

    .hero{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px}
    .hero .big{flex:1 1 320px;background:var(--card);border:2px solid var(--line);border-radius:16px;padding:24px;
      display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;cursor:pointer;
      box-shadow:0 4px 12px rgba(31,41,55,.06);transition:.2s;}
    .hero .big:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(31,41,55,.08);}
    .big.in{background:#e7f6ef;border-color:#ccebdd;color:#0b8a50;} /* hijau lembut */
    .big.out{background:#fff5f5;border-color:#ffe3e3;color:#b42318;} /* merah lembut */

    .hidden{display:none;}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .status{font-size:14px;color:var(--muted);margin-top:6px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--primary-weak);color:#3730a3;font-size:13px}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    .stack{display:flex;flex-direction:column;gap:10px}
    .bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .back{display:inline-flex;align-items:center;gap:8px}
    .back .chev{font-weight:900}
  </style>
</head>
<body>
  <div class="container">

    <!-- ====== VIEW: LANDING ====== -->
    <div id="view-home">
      <h1>CICO Vaksinasi</h1>
      <p class="note">Silakan pilih proses yang akan dilakukan. Anda dapat kembali ke halaman ini kapan pun.</p>

      <div class="hero">
        <button class="big in"   id="goCheckIn">CEK‑IN</button>
        <button class="big out"  id="goCheckOut">CEK‑OUT</button>
      </div>

      <div class="card" style="margin-top:18px">
        <h2>Informasi</h2>
        <p class="note">• Waktu terekam dari <b>server</b> (lebih akurat). • Lokasi wajib aktif. Jika GPS tidak tersedia/ditolak, sistem mencoba <i>perkiraan lokasi</i> via IP.</p>
      </div>
    </div>

    <!-- ====== VIEW: CHECK-IN ====== -->
    <div id="view-checkin" class="hidden">
      <div class="bar">
        <button class="btn-link back" id="backFromIn"><span class="chev">←</span> Kembali</button>
        <h2 style="margin:0">Form Cek‑In</h2>
        <span></span>
      </div>

      <div class="card">
        <div class="stack">
          <div>
            <label>Nomor Order <span style="color:#ef4444">*</span></label>
            <input type="text" id="ci_nomorOrder" placeholder="Contoh: ORD-2026-00123" />
          </div>

          <div>
            <label>Nama Vaksinator</label>
            <input type="text" id="ci_namaVaksinator" placeholder="Nama petugas" />
          </div>

          <div>
            <label>Waktu Server (ISO) <span style="color:#ef4444">*</span></label>
            <input type="text" id="ci_waktuIso"  readonly />
            <div class="status" id="ci_timeStatus">Mengambil waktu server…</div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Latitude <span style="color:#ef4444">*</span></label>
              <input type="text" id="ci_lat"  readonly />
            </div>
            <div style="flex:1">
              <label>Longitude <span style="color:#ef4444">*</span></label>
              <input type="text" id="ci_lng"  readonly />
            </div>
          </div>
          <div class="row">
            <button class="btn btn-ghost" id="ci_btnTime">Ambil Ulang Waktu</button>
            <button class="btn btn-ghost" id="ci_btnLoc">Ambil Ulang Lokasi</button>
            <span id="ci_locBadge" class="badge">Lokasi: —</span>
          </div>
          <div class="status" id="ci_gpsStatus">Mencoba GPS…</div>

          <div>
            <label>Kondisi Vaksin</label>
            <select id="ci_kondisiVaksin">
              <option value="">— Pilih —</option>
              <option>Baik</option>
              <option>Perlu Pendinginan</option>
              <option>Rusak</option>
            </select>
          </div>

          <div>
            <label>Nomor Batch Vaksin (bisa lebih dari satu)</label>
            <div id="ci_batchWrap" class="stack"></div>
            <button type="button" class="btn btn-ghost" id="ci_addBatch">+ Tambah Batch</button>
          </div>

          <div>
            <label>Catatan</label>
            <textarea id="ci_catatan" placeholder="Catatan Cek‑In"></textarea>
          </div>

          <div class="row" style="margin-top:6px">
            <button class="btn btn-primary" id="ci_submit">Kirim Cek‑In</button>
            <button class="btn" type="button" id="ci_reset">Reset</button>
          </div>
          <div class="status" id="ci_status"></div>
        </div>
      </div>
    </div>

    <!-- ====== VIEW: CHECK-OUT ====== -->
    <div id="view-checkout" class="hidden">
      <div class="bar">
        <button class="btn-link back" id="backFromOut"><span class="chev">←</span> Kembali</button>
        <h2 style="margin:0">Form Cek‑Out</h2>
        <span></span>
      </div>

      <div class="card">
        <div class="stack">
          <div>
            <label>Nomor Order <span style="color:#ef4444">*</span></label>
            <input type="text" id="co_nomorOrder" placeholder="Contoh: ORD-2026-00123" />
          </div>

          <div>
            <label>Nama Vaksinator</label>
            <input type="text" id="co_namaVaksinator" placeholder="Nama petugas" />
          </div>

          <div>
            <label>Waktu Server (ISO) <span style="color:#ef4444">*</span></label>
            <input type="text" id="co_waktuIso" readonly />
            <div class="status" id="co_timeStatus">Mengambil waktu server…</div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Latitude <span style="color:#ef4444">*</span></label>
              <input type="text" id="co_lat"  readonly />
            </div>
            <div style="flex:1">
              <label>Longitude <span style="color:#ef4444">*</span></label>
              <input type="text" id="co_lng"  readonly />
            </div>
          </div>
          <div class="row">
            <button class="btn btn-ghost" id="co_btnTime">Ambil Ulang Waktu</button>
            <button class="btn btn-ghost" id="co_btnLoc">Ambil Ulang Lokasi</button>
            <span id="co_locBadge" class="badge">Lokasi: —</span>
          </div>
          <div class="status" id="co_gpsStatus">Mencoba GPS…</div>

          <div>
            <label>No Kandang</label>
            <input type="text" id="co_noKandang" placeholder="Nomor kandang" />
          </div>

          <div>
            <label>Jumlah Ayam Tervaksin</label>
            <input type="number" id="co_jmlAyam" min="0" step="1" />
          </div>

          <div>
            <label>Jumlah Vaksin Terpakai</label>
            <input type="number" id="co_jmlVaksinTerpakai" min="0" step="1" />
          </div>

          <div>
            <label>No Batch Vaksin Terpakai (bisa lebih dari satu)</label>
            <div id="co_batchWrap" class="stack"></div>
            <button type="button" class="btn btn-ghost" id="co_addBatch">+ Tambah Batch</button>
          </div>

          <div>
            <label>Kendala</label>
            <textarea id="co_kendala" placeholder="Kendala jika ada"></textarea>
          </div>

          <div>
            <label>Catatan</label>
            <textarea id="co_catatan" placeholder="Catatan Cek‑Out"></textarea>
          </div>

          <div class="row" style="margin-top:6px">
            <button class="btn btn-primary" id="co_submit">Kirim Cek‑Out</button>
            <button class="btn" type="button" id="co_reset">Reset</button>
          </div>
          <div class="status" id="co_status"></div>
        </div>
      </div>
    </div>

  </div>

<script>
  /* ================== KONFIG FLOW ================== */
  const FLOW_URL = 'PASTE_URL_FLOW_DI_SINI'; // <<=== Ganti dengan URL HTTP Trigger Flow kamu
  /* ================================================= */

  /* ====== HELPER ====== */
  const el = id => document.getElementById(id);
  const show = (id,vis)=> el(id).classList.toggle('hidden', !vis);
  function showView(view){
    show('view-home',     view==='home');
    show('view-checkin',  view==='checkin');
    show('view-checkout', view==='checkout');
  }

  /* ===== UTIL: waktu server ===== */
  async function getServerTime(targetIsoId, targetStatusId){
    const isoEl = el(targetIsoId);
    const stEl  = el(targetStatusId);
    stEl.textContent = 'Mengambil waktu server…';
    try{
      const r = await fetch('https://worldtimeapi.org/api/timezone/Asia/Jakarta',{cache:'no-store'});
      if(!r.ok) throw new Error('fail');
      const j = await r.json();
      isoEl.value = j.datetime; // contoh: 2026-..+07:00
      stEl.textContent = 'Waktu server berhasil diambil.';
    }catch(e){
      const now = new Date();
      isoEl.value = now.toISOString();
      stEl.innerHTML = 'Gagal ambil waktu server, pakai waktu perangkat <span class="warn">(fallback)</span>.';
    }
  }

  /* ===== UTIL: lokasi dengan auto-retry + fallback IP ===== */
  async function tryGPS(targetLatId, targetLngId, targetGpsStatusId, targetBadgeId){
    const latEl = el(targetLatId);
    const lngEl = el(targetLngId);
    const stEl  = el(targetGpsStatusId);
    const badge = el(targetBadgeId);

    const updateBadge = src=>{
      badge.textContent = 'Lokasi: ' + (src==='gps' ? 'GPS' : 'Perkiraan IP');
      badge.style.background = src==='gps' ? '#e0f2fe' : '#fff7ed';
      badge.style.color = src==='gps' ? '#075985' : '#9a3412';
    };

    function getOnce(){
      return new Promise((res,rej)=>{
        if(!navigator.geolocation) return rej(new Error('no gps'));
        navigator.geolocation.getCurrentPosition(
          pos=>res(pos),
          err=>rej(err),
          { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
        );
      });
    }

    for(let i=1;i<=4;i++){
      stEl.textContent = `Mencoba GPS… (percobaan ${i}/4)`;
      try{
        const pos = await getOnce();
        latEl.value = pos.coords.latitude.toFixed(6);
        lngEl.value = pos.coords.longitude.toFixed(6);
        updateBadge('gps');
        stEl.innerHTML = `GPS OK <span class="ok">(±${Math.round(pos.coords.accuracy)} m)</span>`;
        return;
      }catch(err){
        if(err && err.code===1){ // user denied
          stEl.textContent = 'Akses GPS ditolak. Menggunakan lokasi perkiraan (IP)…';
          return fallbackIP(latEl,lngEl,stEl,updateBadge);
        }
        await new Promise(r=>setTimeout(r,1500));
      }
    }
    stEl.textContent = 'GPS masih gagal. Menggunakan lokasi perkiraan (IP)…';
    return fallbackIP(latEl,lngEl,stEl,updateBadge);
  }

  async function fallbackIP(latEl,lngEl,stEl,updateBadge){
    try{
      const r = await fetch('https://ipapi.co/json/',{cache:'no-store'});
      if(!r.ok) throw new Error();
      const j = await r.json();
      if(j && j.latitude && j.longitude){
        latEl.value = Number(j.latitude).toFixed(6);
        lngEl.value = Number(j.longitude).toFixed(6);
        updateBadge('ip');
        stEl.textContent = (`Lokasi perkiraan: ${(j.city||'')} ${(j.region||'')}`).trim();
      }else{
        stEl.textContent = 'Tidak bisa mendapatkan lokasi (IP).';
      }
    }catch(e){
      stEl.textContent = 'Tidak bisa mendapatkan lokasi (IP).';
    }
  }

  /* ===== BATCH FIELD ===== */
  function addBatch(containerId){
    const wrap = el(containerId);
    const row  = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <input type="text" placeholder="No Batch" style="flex:1" />
      <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Hapus</button>`;
    wrap.appendChild(row);
  }

  /* ===== INIT & RESET ===== */
  function initCheckIn(){
    // reset
    el('ci_nomorOrder').value = '';
    el('ci_namaVaksinator').value = '';
    el('ci_waktuIso').value = '';
    el('ci_lat').value = ''; el('ci_lng').value = '';
    el('ci_kondisiVaksin').value = '';
    el('ci_catatan').value = '';
    el('ci_batchWrap').innerHTML = '';
    addBatch('ci_batchWrap');
    el('ci_status').textContent = '';
    // waktu + lokasi
    getServerTime('ci_waktuIso','ci_timeStatus');
    tryGPS('ci_lat','ci_lng','ci_gpsStatus','ci_locBadge');
  }
  function initCheckOut(){
    el('co_nomorOrder').value = '';
    el('co_namaVaksinator').value = '';
    el('co_waktuIso').value = '';
    el('co_lat').value = ''; el('co_lng').value = '';
    el('co_noKandang').value = '';
    el('co_jmlAyam').value = '';
    el('co_jmlVaksinTerpakai').value = '';
    el('co_kendala').value = '';
    el('co_catatan').value = '';
    el('co_batchWrap').innerHTML = '';
    addBatch('co_batchWrap');
    el('co_status').textContent = '';
    getServerTime('co_waktuIso','co_timeStatus');
    tryGPS('co_lat','co_lng','co_gpsStatus','co_locBadge');
  }
  const resetCheckIn  = initCheckIn;
  const resetCheckOut = initCheckOut;

  /* ===== SUBMIT ===== */
  async function sendPayload(payload, statusId){
    const st = el(statusId);
    try{
      if(!FLOW_URL || !/^https?:\\/\\//i.test(FLOW_URL)){
        alert('FLOW_URL belum diisi. Ganti baris FLOW_URL di kode HTML.');
        return;
      }
      st.textContent = 'Mengirim data…';
      const resp = await fetch(FLOW_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!resp.ok){ alert('Gagal mengirim: '+resp.status); st.textContent='Gagal mengirim ('+resp.status+').'; return; }
      let msg = 'Berhasil terkirim.';
      try{ const j = await resp.json(); if(j && j.message) msg=j.message; }catch(_){}
      alert(msg); st.textContent = msg;
    }catch(e){
      console.error(e); alert('Terjadi masalah jaringan. Coba lagi.'); st.textContent='Masalah jaringan saat mengirim.';
    }
  }

  function submitCheckIn(){
    const nomorOrder = el('ci_nomorOrder').value.trim();
    if(!nomorOrder){ alert('Nomor Order wajib diisi.'); return; }
    const waktuIso = el('ci_waktuIso').value.trim();
    if(!waktuIso){ alert('Waktu belum terisi. Klik Ambil Ulang Waktu.'); return; }
    const lat = el('ci_lat').value.trim(), lng = el('ci_lng').value.trim();
    if(!lat || !lng){ alert('Lokasi belum tersedia. Aktifkan GPS dan klik Ambil Ulang Lokasi.'); return; }

    const batchList = Array.from(el('ci_batchWrap').querySelectorAll('input'))
                        .map(i=>i.value.trim()).filter(Boolean);

    const payload = {
      mode:'checkin',
      nomorOrder, waktuIso, latitude:lat, longitude:lng,
      namaVaksinator: el('ci_namaVaksinator').value.trim() || null,
      kondisiVaksin : el('ci_kondisiVaksin').value || null,
      batchVaksin   : batchList,
      catatanCheckIn: el('ci_catatan').value || null
    };
    sendPayload(payload, 'ci_status');
  }

  function submitCheckOut(){
    const nomorOrder = el('co_nomorOrder').value.trim();
    if(!nomorOrder){ alert('Nomor Order wajib diisi.'); return; }
    const waktuIso = el('co_waktuIso').value.trim();
    if(!waktuIso){ alert('Waktu belum terisi. Klik Ambil Ulang Waktu.'); return; }
    const lat = el('co_lat').value.trim(), lng = el('co_lng').value.trim();
    if(!lat || !lng){ alert('Lokasi belum tersedia. Aktifkan GPS dan klik Ambil Ulang Lokasi.'); return; }

    const batchOut = Array.from(el('co_batchWrap').querySelectorAll('input'))
                        .map(i=>i.value.trim()).filter(Boolean);

    const payload = {
      mode:'checkout',
      nomorOrder, waktuIso, latitude:lat, longitude:lng,
      namaVaksinator: el('co_namaVaksinator').value.trim() || null,
      noKandang: el('co_noKandang').value || null,
      jumlahAyamTervaksin : el('co_jmlAyam').value ? Number(el('co_jmlAyam').value) : null,
      jumlahVaksinTerpakai: el('co_jmlVaksinTerpakai').value ? Number(el('co_jmlVaksinTerpakai').value) : null,
      batchVaksinTerpakai : batchOut,
      kendala : el('co_kendala').value || null,
      catatanCheckOut: el('co_catatan').value || null
    };
    sendPayload(payload, 'co_status');
  }

  /* ===== WIRING EVENT ===== */
  document.addEventListener('DOMContentLoaded',()=>{
    // navigasi
    el('goCheckIn').addEventListener('click', ()=>{ showView('checkin');  initCheckIn(); });
    el('goCheckOut').addEventListener('click',()=>{ showView('checkout'); initCheckOut(); });
    el('backFromIn').addEventListener('click', ()=> showView('home'));
    el('backFromOut').addEventListener('click',()=> showView('home'));

    // tombol util check-in
    el('ci_btnTime').addEventListener('click', ()=> getServerTime('ci_waktuIso','ci_timeStatus'));
    el('ci_btnLoc').addEventListener('click',  ()=> tryGPS('ci_lat','ci_lng','ci_gpsStatus','ci_locBadge'));
    el('ci_addBatch').addEventListener('click',()=> addBatch('ci_batchWrap'));
    el('ci_submit').addEventListener('click',   submitCheckIn);
    el('ci_reset').addEventListener('click',    initCheckIn);

    // tombol util check-out
    el('co_btnTime').addEventListener('click', ()=> getServerTime('co_waktuIso','co_timeStatus'));
    el('co_btnLoc').addEventListener('click',  ()=> tryGPS('co_lat','co_lng','co_gpsStatus','co_locBadge'));
    el('co_addBatch').addEventListener('click',()=> addBatch('co_batchWrap'));
    el('co_submit').addEventListener('click',   submitCheckOut);
    el('co_reset').addEventListener('click',    initCheckOut);

    // mulai di home
    showView('home');
  });
</script>
</body>
</html>
