¬†
<!DOCTYPE html>
<html lang="id">
<head>
  <!-- =========================================================
  =============== [A] META & TITLE =============================
  ========================================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CICO Vaksinasi</title>

  <!-- =========================================================
  =============== [B] STYLES / UI THEME =======================
  ========================================================== -->
  <style>
    :root{
      --bg:#eef2f7;
      --card:#ffffff;
      --primary:#1e40af;
      --secondary:#6366f1;
      --border:#dbe2f1;
      --muted:#64748b;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:linear-gradient(180deg,#f4f7fb,#e9eef7);
      color:#0f172a;
    }
    .container{max-width:960px;margin:28px auto;padding:0 16px}
    .hidden{display:none !important}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:22px;
      margin-bottom:18px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .section-title{font-weight:700;color:#1e3a8a;margin-bottom:12px}
    label{font-weight:600;display:block;margin:12px 0 6px}

    input,select,textarea{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:15px;
      background:#fff;
    }
    input[readonly]{background:#f5f7fb}
    textarea{min-height:90px}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{flex:1}

    .btn{padding:12px 16px;border-radius:12px;border:none;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:#eef2ff;color:#1e3a8a}
    .btn-danger{background:#fee2e2;color:#b91c1c}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    .warn{
      background:#fff1f2;
      color:var(--danger);
      padding:12px;
      border-radius:10px;
      margin-bottom:12px;
    }

    .badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background:#eef2ff;
      color:#1e3a8a;
      font-size:13px;
      margin-top:6px;
    }

    /* =============== Landing =============== */
    .landing-wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#e0e7ff,#eef2f7);
    }
    .landing-card{
      background:linear-gradient(180deg,#ffffff,#f8fafc);
      border-radius:22px;
      padding:40px 28px;
      max-width:420px;
      width:100%;
      text-align:center;
      box-shadow:0 24px 50px rgba(30,64,175,.2);
      border:1px solid var(--border);
    }
    .landing-card h1{font-size:30px;margin:6px 0;color:#1e3a8a}
    .landing-card p{font-size:15px;color:#1f2937;margin-bottom:28px}
    .landing-actions{display:grid;gap:14px}
    .footer-note{margin-top:22px;font-size:13px;color:#64748b}

    /* =============== Foto preview =============== */
    .photos-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .photo-item{
      position:relative;
      width:72px;height:72px;
      border-radius:8px;border:1px solid var(--border);
      overflow:hidden;background:#f8fafc
    }
    .photo-item img{width:100%;height:100%;object-fit:cover}
    .photo-del{
      position:absolute;top:2px;right:2px;
      background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:999px;
      width:20px;height:20px;line-height:20px;text-align:center;font-size:13px;cursor:pointer
    }
    .hint{color:#64748b;font-size:12px;margin-top:4px}

    /* =============== Signature Pad (Cek-Out only) =============== */
    .sig-wrap{
      border:1px dashed var(--border);
      border-radius:12px;
      background:#f8fafc;
      padding:10px;
      margin-top:14px;
    }
    .sig-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .sig-toolbar .title{font-weight:600;color:#1e3a8a;font-size:14px}
    canvas.sig{
      width:100%;height:180px;border-radius:8px;background:#fff;border:1px solid var(--border)
    }
  </style>
</head>

<body>

  <!-- =========================================================
  =============== [C] VIEW: HOME / LANDING =====================
  ========================================================== -->
  <div id="view-home" class="landing-wrap">
    <div class="landing-card">
      <div style="font-size:44px">üíâ</div>
      <h1>CICO Vaksinasi</h1>
      <p>Sistem Check-In &amp; Check-Out Vaksinasi<br>Dengan Lokasi &amp; Waktu Otomatis</p>
      <div class="landing-actions">
        <button class="btn btn-primary" onclick="show('checkin')">‚úÖ CEK-IN VAKSIN</button>
        <button class="btn btn-ghost" onclick="show('checkout')">üöö CEK-OUT VAKSIN</button>
      </div>
      <div class="footer-note">üìç GPS ‚Ä¢ ‚è±Ô∏è Waktu Sistem ‚Ä¢ üì∏ Multi Foto ‚Ä¢ ‚úçÔ∏è Tanda Tangan Digital (Cek-Out)</div>
    </div>
  </div>

  <!-- =========================================================
  =============== [D] VIEW: CEK-IN ==============================
  ========================================================== -->
  <div id="view-checkin" class="container hidden">
    <button class="btn btn-ghost" onclick="show('home')">‚Üê Kembali</button>
    <h2>Form Cek-In</h2>

    <div id="ci_warn" class="warn hidden"></div>

    <!-- ===== [D1] Data Otomatis (Sistem) ===== -->
    <div class="card">
      <div class="section-title">Data Otomatis (Sistem)</div>
      <div class="row">
        <div>
          <label>Tanggal</label>
          <input id="ci_tanggal" readonly />
        </div>
        <div>
          <label>Jam</label>
          <input id="ci_jam" readonly />
        </div>
      </div>

      <label>Nama Lokasi</label>
      <input id="ci_lokasi" readonly />
      <span id="ci_src" class="badge">Lokasi: -</span>

      <div class="row">
        <div>
          <label>Latitude</label>
          <input id="ci_lat" readonly />
        </div>
        <div>
          <label>Longitude</label>
          <input id="ci_lng" readonly />
        </div>
      </div>
    </div>

    <!-- ===== [D2] Data Diisi Petugas ===== -->
    <div class="card">
      <div class="section-title">Data Diisi Petugas</div>

      <label>Nomor Order</label>
      <select id="ci_order">
        <option value="">‚è≥ Memuat...</option>
      </select>

      <label>Nama Vaksinator</label>
      <input id="ci_nama" placeholder="Nama lengkap petugas" />

      <label>Kondisi Vaksin</label>
      <select id="ci_kondisi">
        <option value="">-- Pilih --</option>
        <option>Baik</option>
        <option>Perlu Pendinginan</option>
        <option>Rusak</option>
        <option>Thawing</option>
        <option>Tidak Thawing</option>
      </select>

      <label>Nomor Batch Vaksin</label>
      <div id="ci_batch_wrap"></div>
      <div class="btn-group">
        <button class="btn btn-ghost" type="button" onclick="addBatch()">‚ûï Tambah Batch</button>
        <button class="btn btn-ghost" type="button" onclick="resetBatches()">‚Ü∫ Reset Batch</button>
      </div>

      <label>Upload Foto (maks. 5)</label>
      <input type="file" id="ci_fotos" accept="image/*" multiple />
      <div class="hint">Pilih 1‚Äì5 foto. Bisa hapus per-foto (ikon √ó) atau hapus semua.</div>
      <div id="ci_fotos_preview" class="photos-preview"></div>
      <div class="btn-group">
        <button type="button" id="ci_fotos_clear" class="btn btn-danger">üóëÔ∏è Hapus Semua Foto</button>
      </div>

      <label>Catatan</label>
      <textarea id="ci_catatan" placeholder="Opsional"></textarea>

      <div class="btn-group">
        <button class="btn btn-primary" type="button" onclick="submitCI()">Kirim Cek-In</button>
        <button class="btn btn-ghost" type="button" onclick="resetForm('ci')">‚Ü∫ Reset Form</button>
      </div>
    </div>
  </div>

  <!-- =========================================================
  =============== [E] VIEW: CEK-OUT =============================
  ========================================================== -->
  <div id="view-checkout" class="container hidden">
    <button class="btn btn-ghost" onclick="show('home')">‚Üê Kembali</button>
    <h2>Form Cek-Out</h2>

    <div id="co_warn" class="warn hidden"></div>

    <!-- ===== [E1] Data Otomatis (Sistem) ===== -->
    <div class="card">
      <div class="section-title">Data Otomatis (Sistem)</div>
      <div class="row">
        <div>
          <label>Tanggal</label>
          <input id="co_tanggal" readonly />
        </div>
        <div>
          <label>Jam</label>
          <input id="co_jam" readonly />
        </div>
      </div>

      <label>Nama Lokasi</label>
      <input id="co_lokasi" readonly />
      <span id="co_src" class="badge">Lokasi: -</span>

      <div class="row">
        <div>
          <label>Latitude</label>
          <input id="co_lat" readonly />
        </div>
        <div>
          <label>Longitude</label>
          <input id="co_lng" readonly />
        </div>
      </div>
    </div>

    <!-- ===== [E2] Data Diisi Petugas ===== -->
    <div class="card">
      <div class="section-title">Data Diisi Petugas</div>

      <label>Nomor Order</label>
      <select id="co_order">
        <option value="">‚è≥ Memuat...</option>
      </select>

      <label>Nama Vaksinator</label>
      <input id="co_nama" placeholder="Nama lengkap petugas" />

      <label>No Kandang</label>
      <input id="co_kandang" placeholder="Contoh: A-12" />

      <label>Jumlah Ayam Tervaksin</label>
      <input type="number" id="co_ayam" min="0" step="1" placeholder="0" />

      <label>Jumlah Vaksin Terpakai</label>
      <input type="number" id="co_vaksin" min="0" step="1" placeholder="0" />

      <label>Upload Foto (maks. 5)</label>
      <input type="file" id="co_fotos" accept="image/*" multiple />
      <div class="hint">Pilih 1‚Äì5 foto. Bisa hapus per-foto (ikon √ó) atau hapus semua.</div>
      <div id="co_fotos_preview" class="photos-preview"></div>
      <div class="btn-group">
        <button type="button" id="co_fotos_clear" class="btn btn-danger">üóëÔ∏è Hapus Semua Foto</button>
      </div>

      <!-- ===== [E3] Signature Pad (Cek-Out) ===== -->
      <div class="sig-wrap">
        <div class="sig-toolbar">
          <div class="title">Tanda Tangan Digital (Petugas Farm)</div>
          <button type="button" class="btn btn-ghost" onclick="clearSignature('co')">Hapus TTD</button>
        </div>
        <canvas id="co_sig_canvas" class="sig"></canvas>
        <input type="hidden" id="co_signature_data" />
      </div>

      <label>Catatan</label>
      <textarea id="co_catatan" placeholder="Opsional"></textarea>

      <div class="btn-group">
        <button class="btn btn-primary" type="button" onclick="submitCO()">Kirim Cek-Out</button>
        <button class="btn btn-ghost" type="button" onclick="resetForm('co')">‚Ü∫ Reset Form</button>
      </div>
    </div>
  </div>

  <!-- =========================================================
  =============== [F] LOADING OVERLAY ==========================
  ========================================================== -->
  <div id="loading" class="hidden"
    style="
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      font-weight:600;
      font-size:18px;">
    ‚è≥ Memproses...
  </div>

  <!-- =========================================================
  =============== [G] SCRIPT / LOGIC ===========================
  ========================================================== -->

<script>
  /* =========================================================
  =============== [G1] KONFIGURASI ENDPOINT ==================
  ========================================================== */

  const FLOW_GET_ORDER_URL =
    "https://default08c67d278fe34663834968bc1ace2e.be.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/0b8ea542919749eeabb66e27e32c1b5a/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Ly_DAybOG8S6gwh03EPU-jGikDyD084xiN_-M-Kaa0I";

  const FLOW_SUBMIT_URL =
    "https://default08c67d278fe34663834968bc1ace2e.be.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/fbda6accf77d48cbbaf3b879ff63287d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=r3rqKUO_yBMlf-9D8L1uQsF4re6EuUC-gK11I6cY29g";

  const MAX_PHOTOS = 5;
  const REQUIRE_SIGNATURE_CO = true;

  const $ = (id) => document.getElementById(id);

  /* =========================================================
  =============== [G2] LOADING UI ============================
  ========================================================== */
  function showLoading(msg) {
    const el = $("loading");
    if (msg) el.textContent = msg;
    el.classList.remove("hidden");
  }
  function hideLoading() {
    const el = $("loading");
    el.classList.add("hidden");
    el.textContent = "‚è≥ Memproses...";
  }

  /* =========================================================
  =============== [G3] NAVIGASI VIEW =========================
  ========================================================== */
  function show(v) {
    $("view-home").classList.add("hidden");
    $("view-checkin").classList.add("hidden");
    $("view-checkout").classList.add("hidden");

    const target = $("view-" + v);
    if (target) target.classList.remove("hidden");

    window.scrollTo({ top: 0, behavior: "auto" });

    if (v === "checkin") {
      init("ci");
      initBatches();
      loadOrders("ci_order");
      attachMultiPhotoHandler("ci_fotos", "ci_fotos_preview", "ci_fotos_clear");
    }
    if (v === "checkout") {
      init("co");
      loadOrders("co_order");
      initSignatureOnce("co");
      attachMultiPhotoHandler("co_fotos", "co_fotos_preview", "co_fotos_clear");
    }
  }

  /* =========================================================
  =============== [G4] INIT TANGGAL & JAM ====================
  ========================================================== */
  function init(p) {
    const d = new Date();
    $(p + "_tanggal").value = d.toLocaleDateString("id-ID", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
    $(p + "_jam").value = d.toLocaleTimeString("id-ID", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    });
    loadLocation(p);
  }

  /* =========================================================
  =============== [G5] LOKASI (GPS -> IP fallback) ===========
  ========================================================== */
  function simplifyAddress(a) {
    const parts = (a || "").split(",");
    return parts.slice(1).join(",").trim() || (a || "");
  }

  async function loadLocation(p) {
    const src = $(p + "_src");

    if (!navigator.geolocation) {
      src.textContent = "Lokasi: Tidak tersedia";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        $(p + "_lat").value = pos.coords.latitude.toFixed(6);
        $(p + "_lng").value = pos.coords.longitude.toFixed(6);
        src.textContent = "Lokasi: GPS";

        try {
          const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`;
          const r = await fetch(url, { headers: { "Accept": "application/json" } });
          const j = await r.json();
          if (j?.display_name) {
            $(p + "_lokasi").value = simplifyAddress(j.display_name);
          }
        } catch (e) {
          console.warn("Gagal reverse geocode", e);
        }
      },
      async () => {
        try {
          const r = await fetch("https://ipapi.co/json/");
          const j = await r.json();
          $(p + "_lat").value = j.latitude ?? "";
          $(p + "_lng").value = j.longitude ?? "";
          $(p + "_lokasi").value = `${j.city ?? "-"}, ${j.region ?? "-"}, ${j.country_name ?? "-"}`;
          src.textContent = "Lokasi: Perkiraan IP";
        } catch (e) {
          console.warn("Gagal ambil lokasi via IP", e);
          src.textContent = "Lokasi: Tidak tersedia";
        }
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  /* =========================================================
  =============== [G6] BATCHES (CEK-IN) ======================
  ========================================================== */
  function initBatches() {
    $("ci_batch_wrap").innerHTML = "";
    addBatch();
  }
  function addBatch() {
    const wrap = $("ci_batch_wrap");
    const i = document.createElement("input");
    i.placeholder = "Nomor Batch";
    i.style.marginBottom = "8px";
    wrap.appendChild(i);
  }
  function resetBatches() {
    initBatches();
  }
  function getBatchValues() {
    const inputs = Array.from($("ci_batch_wrap").querySelectorAll("input"));
    return inputs.map((i) => i.value.trim()).filter((v) => v !== "");
  }

  /* =========================================================
  =============== [G7] FOTO: PREVIEW + DELETE =================
  ========================================================== */
  const photoHandlers = {}; // per inputId: {urls:[], clear, render, removeAt}

  function attachMultiPhotoHandler(inputId, previewId, clearBtnId) {
    const inp = $(inputId);
    const preview = $(previewId);
    const clearBtn = clearBtnId ? $(clearBtnId) : null;

    if (!photoHandlers[inputId]) {
      photoHandlers[inputId] = { urls: [] };
    }
    const state = photoHandlers[inputId];

    function revokeAll() {
      (state.urls || []).forEach((u) => URL.revokeObjectURL(u));
      state.urls = [];
    }

    function syncLimit() {
      let files = Array.from(inp.files || []);
      if (files.length > MAX_PHOTOS) {
        alert(`Maksimal ${MAX_PHOTOS} foto. Hanya ${MAX_PHOTOS} pertama yang digunakan.`);
        const dt = new DataTransfer();
        files.slice(0, MAX_PHOTOS).forEach((f) => dt.items.add(f));
        inp.files = dt.files;
        files = Array.from(inp.files);
      }
      return files;
    }

    function render() {
      const files = syncLimit();
      revokeAll();
      preview.innerHTML = "";

      files.forEach((f, idx) => {
        if (!f.type.startsWith("image/")) return;

        const item = document.createElement("div");
        item.className = "photo-item";

        const img = document.createElement("img");
        img.alt = f.name;

        const url = URL.createObjectURL(f);
        state.urls.push(url);
        img.src = url;

        const del = document.createElement("button");
        del.className = "photo-del";
        del.type = "button";
        del.textContent = "√ó";
        del.title = "Hapus foto ini";
        del.onclick = () => removeAt(idx);

        item.appendChild(img);
        item.appendChild(del);
        preview.appendChild(item);
      });
    }

    function clearAll() {
      try {
        const dt = new DataTransfer();
        inp.files = dt.files;
      } catch {
        inp.value = "";
      }
      revokeAll();
      preview.innerHTML = "";
    }

    function removeAt(idx) {
      const files = Array.from(inp.files || []);
      const dt = new DataTransfer();
      files.forEach((f, i) => {
        if (i !== idx) dt.items.add(f);
      });
      inp.files = dt.files;
      render();
    }

    if (clearBtn) clearBtn.onclick = clearAll;
    inp.onchange = render;

    state.clear = clearAll;
    state.render = render;
    state.removeAt = removeAt;
  }

  /* =========================================================
  =============== [G8] SIGNATURE PAD (CEK-OUT) ================
  ========================================================== */
  const sigPads = {}; // {co:{initialized, canvas, ctx, signed, clear}}

  function initSignatureOnce(prefix) {
    if (sigPads[prefix]?.initialized) return;

    const canvas = $(prefix + "_sig_canvas");
    const hidden = $(prefix + "_signature_data");

    const pad = { initialized: true, canvas, ctx: null, signed: false, clear: null };
    sigPads[prefix] = pad;

    function setupCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();

      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);

      const ctx = canvas.getContext("2d");
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#0f172a";

      ctx.save();
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore();

      pad.ctx = ctx;
      return ctx;
    }

    const ctx = setupCanvas();
    let drawing = false,
      last = { x: 0, y: 0 };

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches.length) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top,
        };
      }
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function start(e) {
      e.preventDefault();
      drawing = true;
      last = getPos(e);
    }
    function move(e) {
      if (!drawing) return;
      e.preventDefault();
      const p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      last = p;
      pad.signed = true;
    }
    function end() {
      if (!drawing) return;
      drawing = false;
      if (pad.signed) hidden.value = canvas.toDataURL("image/png");
    }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    canvas.addEventListener("mouseup", end);
    canvas.addEventListener("mouseleave", end);

    canvas.addEventListener("touchstart", start, { passive: false });
    canvas.addEventListener("touchmove", move, { passive: false });
    canvas.addEventListener("touchend", end);

    pad.clear = () => {
      const cctx = pad.ctx;
      cctx.save();
      cctx.setTransform(1, 0, 0, 1, 0, 0);
      cctx.clearRect(0, 0, canvas.width, canvas.height);
      cctx.fillStyle = "#fff";
      cctx.fillRect(0, 0, canvas.width, canvas.height);
      cctx.restore();

      pad.signed = false;
      hidden.value = "";
    };
  }

  function clearSignature(prefix) {
    sigPads[prefix]?.clear?.();
  }

  /* =========================================================
  =============== [G9] LOAD ORDERS (DARI FLOW GET ORDER) ======
  ========================================================== */
  async function loadOrders(selectId) {
    console.log("loadOrders called:", selectId);

    const sel = $(selectId);
    sel.innerHTML = '<option value="">-- Pilih Nomor Order --</option>';

    const type = selectId.startsWith("ci") ? "checkin" : "checkout";

    try {
      showLoading("‚è≥ Mengambil data order...");

      const r = await fetch(FLOW_GET_ORDER_URL, {
        method: "POST",
        headers: {
          "Content-Type": "text/plain; charset=UTF-8",
          Accept: "application/json",
        },
        body: type,
      });

      const raw = await r.text();
      console.log("[FLOW] HTTP:", r.status);
      console.log("[FLOW] RAW:", raw);

      if (!r.ok) {
        throw new Error(`HTTP ${r.status} - ${raw.slice(0, 300)}`);
      }

      const safeJson = (x) => {
        if (x == null) return null;
        if (typeof x === "object") return x;
        if (typeof x !== "string") return null;
        try {
          const p1 = JSON.parse(x);
          if (typeof p1 === "string") {
            try {
              return JSON.parse(p1);
            } catch {
              return p1;
            }
          }
          return p1;
        } catch {
          return null;
        }
      };

      let j = safeJson(raw);
      if (!j) throw new Error("Response tidak bisa diparse JSON.");

      if (j.body) {
        const bodyParsed = safeJson(j.body) || j.body;
        if (typeof bodyParsed === "object") j = { ...j, body: bodyParsed };
      }

      let list =
        (Array.isArray(j?.body?.orders) ? j.body.orders : null) ||
        (Array.isArray(j?.orders) ? j.orders : null) ||
        (Array.isArray(j?.body) ? j.body : null) ||
        (Array.isArray(j?.value) ? j.value : null) ||
        [];

      console.log("[FLOW] parsed:", j);
      console.log("[FLOW] list length:", list.length);

      if (!Array.isArray(list) || list.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "(Tidak ada data order / struktur response tidak sesuai)";
        sel.appendChild(opt);
        return;
      }

      list.forEach((o) => {
        let val = "";
        if (typeof o === "string") {
          val = o;
        } else {
          val = (o?.Value ?? o?.value ?? o?.orderNumber ?? o?.OrderNumber ?? "").toString();
        }

        val = val.replace(/\s+/g, " ").trim();
        if (!val) return;

        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        sel.appendChild(opt);
      });

      if (sel.options.length <= 1) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "(Data ada, tapi field Value/orderNumber tidak ditemukan)";
        sel.appendChild(opt);
      }
    } catch (e) {
      console.error("Gagal mengambil data order", e);
      alert("Gagal mengambil data order.\n\nDETAIL:\n" + (e?.message || e));
    } finally {
      hideLoading();
    }
  }

  /* =========================================================
  =============== [G10] HELPERS: BASE64 FOTO & SUBMIT JSON =====
  ========================================================== */
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => {
        const result = String(r.result || "");
        const base64 = result.includes(",") ? result.split(",")[1] : result;
        resolve(base64);
      };
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function buildPhotosPayload(inputId, prefix) {
    const files = Array.from($(inputId).files || []).slice(0, MAX_PHOTOS);
    const photos = [];

    for (let i = 0; i < files.length; i++) {
      const f = files[i];
      if (!f.type.startsWith("image/")) continue;

      const ext = (f.name.split(".").pop() || "jpg").toLowerCase();
      const safeName = `${prefix}_photo_${i + 1}.${ext}`;

      photos.push({
        fileName: safeName,
        contentType: f.type || "application/octet-stream",
        contentBytes: await fileToBase64(f),
      });
    }
    return photos;
  }

  async function sendJson(url, payload) {
    if (!url) {
      console.log("[DEBUG payload submit JSON]", payload);
      await new Promise((r) => setTimeout(r, 400));
      return { ok: true, debug: true };
    }

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const text = await resp.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch {
      data = { raw: text };
    }

    return { ok: resp.ok, status: resp.status, data };
  }

  /* =========================================================
  =============== [G11] SUBMIT: CEK-IN (JSON) =================
  ========================================================== */
  async function submitCI() {
    const warn = $("ci_warn");
    warn.classList.add("hidden");
    warn.textContent = "";

    const order = $("ci_order").value;
    const nama = $("ci_nama").value.trim();
    const kondisi = $("ci_kondisi").value;
    const batches = getBatchValues();
    const fotos = $("ci_fotos").files;

    if (!order || !nama || !kondisi) {
      warn.textContent = "‚ö†Ô∏è Nomor Order, Nama Vaksinator, dan Kondisi wajib diisi.";
      warn.classList.remove("hidden");
      return;
    }
    if (batches.length === 0) {
      warn.textContent = "‚ö†Ô∏è Minimal 1 Nomor Batch diisi.";
      warn.classList.remove("hidden");
      return;
    }
    if (!fotos || fotos.length === 0) {
      warn.textContent = "‚ö†Ô∏è Wajib unggah minimal 1 foto (maksimal 5).";
      warn.classList.remove("hidden");
      return;
    }
    if (fotos.length > MAX_PHOTOS) {
      warn.textContent = `‚ö†Ô∏è Maksimal ${MAX_PHOTOS} foto.`;
      warn.classList.remove("hidden");
      return;
    }

    try {
      showLoading("‚è≥ Menyiapkan foto (base64)...");

      const payload = {
        formType: "checkin",
        orderNumber: order,
        namaVaksinator: nama,
        kondisiVaksin: kondisi,
        tanggal: $("ci_tanggal").value,
        jam: $("ci_jam").value,
        lokasi: $("ci_lokasi").value,
        latitude: $("ci_lat").value,
        longitude: $("ci_lng").value,
        catatan: $("ci_catatan").value || "",
        batches: batches,
        photos: await buildPhotosPayload("ci_fotos", "ci"),
      };

      showLoading("‚è≥ Mengirim Cek-In...");
      const resp = await sendJson(FLOW_SUBMIT_URL, payload);
      hideLoading();

      if (resp.ok) {
        alert("‚úÖ Cek-In berhasil");
        show("home");
      } else {
        console.error(resp);
        alert(`‚ùå Gagal submit Cek-In (HTTP ${resp.status}).\n` + (resp.data?.message || resp.data?.raw || ""));
      }
    } catch (e) {
      hideLoading();
      console.error(e);
      alert("‚ùå Terjadi kesalahan saat submit Cek-In: " + (e?.message || e));
    }
  }

  /* =========================================================
  =============== [G12] SUBMIT: CEK-OUT (JSON + SIGNATURE) =====
  ========================================================== */
  async function submitCO() {
    const warn = $("co_warn");
    warn.classList.add("hidden");
    warn.textContent = "";

    const order = $("co_order").value;
    const nama = $("co_nama").value.trim();
    const kandang = $("co_kandang").value.trim();
    const ayam = $("co_ayam").value;
    const vaksin = $("co_vaksin").value;
    const fotos = $("co_fotos").files;
    const sigDataURL = $("co_signature_data").value;

    if (!order || !nama || !kandang) {
      warn.textContent = "‚ö†Ô∏è Nomor Order, Nama Vaksinator, dan No Kandang wajib diisi.";
      warn.classList.remove("hidden");
      return;
    }
    if (ayam === "" || Number(ayam) < 0 || vaksin === "" || Number(vaksin) < 0) {
      warn.textContent = "‚ö†Ô∏è Jumlah Ayam dan Vaksin harus diisi dengan angka ‚â• 0.";
      warn.classList.remove("hidden");
      return;
    }
    if (!fotos || fotos.length === 0) {
      warn.textContent = "‚ö†Ô∏è Wajib unggah minimal 1 foto (maksimal 5).";
      warn.classList.remove("hidden");
      return;
    }
    if (fotos.length > MAX_PHOTOS) {
      warn.textContent = `‚ö†Ô∏è Maksimal ${MAX_PHOTOS} foto.`;
      warn.classList.remove("hidden");
      return;
    }
    if (REQUIRE_SIGNATURE_CO && !sigDataURL) {
      warn.textContent = "‚ö†Ô∏è Tanda tangan digital wajib.";
      warn.classList.remove("hidden");
      return;
    }

    try {
      showLoading("‚è≥ Menyiapkan foto & signature...");

      const payload = {
        formType: "checkout",
        orderNumber: order,
        namaVaksinator: nama,
        noKandang: kandang,
        jumlahAyam: Number(ayam),
        jumlahVaksin: Number(vaksin),
        tanggal: $("co_tanggal").value,
        jam: $("co_jam").value,
        lokasi: $("co_lokasi").value,
        latitude: $("co_lat").value,
        longitude: $("co_lng").value,
        catatan: $("co_catatan").value || "",
        photos: await buildPhotosPayload("co_fotos", "co"),
      };

      if (sigDataURL) {
        const base64Sig = String(sigDataURL).split(",")[1] || "";
        payload.signature = {
          fileName: "signature_co.png",
          contentType: "image/png",
          contentBytes: base64Sig,
        };
      }

      showLoading("‚è≥ Mengirim Cek-Out...");
      const resp = await sendJson(FLOW_SUBMIT_URL, payload);
      hideLoading();

      if (resp.ok) {
        alert("‚úÖ Cek-Out berhasil");
        show("home");
      } else {
        console.error(resp);
        alert(`‚ùå Gagal submit Cek-Out (HTTP ${resp.status}).\n` + (resp.data?.message || resp.data?.raw || ""));
      }
    } catch (e) {
      hideLoading();
      console.error(e);
      alert("‚ùå Terjadi kesalahan saat submit Cek-Out: " + (e?.message || e));
    }
  }

  /* =========================================================
  =============== [G13] RESET FORM ============================
  ========================================================== */
  function resetForm(prefix) {
    const warnEl = $(prefix + "_warn");
    if (warnEl) {
      warnEl.classList.add("hidden");
      warnEl.textContent = "";
    }

    const viewId = prefix === "ci" ? "checkin" : "checkout";

    const selOrder = $(prefix + "_order");
    if (selOrder) selOrder.selectedIndex = 0;

    const fields = Array.from(
      document.querySelectorAll(
        `#view-${viewId} input, #view-${viewId} textarea, #view-${viewId} select`
      )
    );

    fields.forEach((el) => {
      if (
        el.id.endsWith("_tanggal") ||
        el.id.endsWith("_jam") ||
        el.id.endsWith("_lokasi") ||
        el.id.endsWith("_lat") ||
        el.id.endsWith("_lng")
      )
        return;

      if (el.tagName === "SELECT") {
        if (el.id !== prefix + "_order") el.selectedIndex = 0;
      } else if (el.type === "hidden") {
        el.value = "";
      } else if (el.type === "file") {
        // clear via handler
      } else {
        el.value = "";
      }
    });

    if (prefix === "ci") initBatches();

    const photoId = prefix + "_fotos";
    if (photoHandlers[photoId]?.clear) photoHandlers[photoId].clear();

    if (prefix === "co") clearSignature("co");

    init(prefix); // refresh tanggal/jam/lokasi
  }
</script>
</body>
</html>
