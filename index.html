
<!DOCTYPE html>
<html lang="id">
<head>
  <!-- ================= META ================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>CICO Vaksinasi</title>

  <style>
    :root{
      --bg:#eef2f7;
      --card:#ffffff;
      --primary:#1e40af;
      --secondary:#6366f1;
      --border:#dbe2f1;
      --muted:#64748b;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:linear-gradient(180deg,#f4f7fb,#e9eef7);
      color:#0f172a;
    }
    .container{max-width:960px;margin:28px auto;padding:0 16px}
    .hidden{display:none !important}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:22px;
      margin-bottom:18px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .section-title{font-weight:700;color:#1e3a8a;margin-bottom:12px}
    label{font-weight:600;display:block;margin:12px 0 6px}

    input,select,textarea{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:15px;
      background:#fff;
    }
    input[readonly]{background:#f5f7fb}
    textarea{min-height:90px}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{flex:1}

    .btn{padding:12px 16px;border-radius:12px;border:none;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:#eef2ff;color:#1e3a8a}
    .btn-danger{background:#fee2e2;color:#b91c1c}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    .warn{
      background:#fff1f2;
      color:var(--danger);
      padding:12px;
      border-radius:10px;
      margin-bottom:12px;
    }

    .badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background:#eef2ff;
      color:#1e3a8a;
      font-size:13px;
      margin-top:6px;
    }

    /* Landing */
    .landing-wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#e0e7ff,#eef2f7);
    }
    .landing-card{
      background:linear-gradient(180deg,#ffffff,#f8fafc);
      border-radius:22px;
      padding:40px 28px;
      max-width:420px;
      width:100%;
      text-align:center;
      box-shadow:0 24px 50px rgba(30,64,175,.2);
      border:1px solid var(--border);
    }
    .landing-card h1{font-size:30px;margin:6px 0;color:#1e3a8a}
    .landing-card p{font-size:15px;color:#1f2937;margin-bottom:28px}
    .landing-actions{display:grid;gap:14px}
    .footer-note{margin-top:22px;font-size:13px;color:#64748b}

    /* Foto preview */
    .photos-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .photo-item{
      position:relative;
      width:72px;height:72px;
      border-radius:8px;border:1px solid var(--border);
      overflow:hidden;background:#f8fafc
    }
    .photo-item img{width:100%;height:100%;object-fit:cover}
    .photo-del{
      position:absolute;top:2px;right:2px;
      background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:999px;
      width:20px;height:20px;line-height:20px;text-align:center;font-size:13px;cursor:pointer
    }
    .hint{color:#64748b;font-size:12px;margin-top:4px}

    /* Signature (Cek-Out only) */
    .sig-wrap{
      border:1px dashed var(--border);
      border-radius:12px;
      background:#f8fafc;
      padding:10px;
      margin-top:14px;
    }
    .sig-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .sig-toolbar .title{font-weight:600;color:#1e3a8a;font-size:14px}
    canvas.sig{
      width:100%;height:180px;border-radius:8px;background:#fff;border:1px solid var(--border)
    }
  </style>
</head>

<body>

<!-- ========================= HOME ========================= -->
<div id="view-home" class="landing-wrap">
  <div class="landing-card">
    <div style="font-size:44px">üíâ</div>
    <h1>CICO Vaksinasi</h1>
    <p>Sistem Check-In &amp; Check-Out Vaksinasi<br>Dengan Lokasi &amp; Waktu Otomatis</p>
    <div class="landing-actions">
      <button class="btn btn-primary" onclick="show('checkin')">‚úÖ CEK-IN VAKSIN</button>
      <button class="btn btn-ghost" onclick="show('checkout')">üöö CEK-OUT VAKSIN</button>
    </div>
    <div class="footer-note">üìç GPS ‚Ä¢ ‚è±Ô∏è Waktu Sistem ‚Ä¢ üì∏ Multi Foto ‚Ä¢ ‚úçÔ∏è Tanda Tangan Digital (Cek-Out)</div>
  </div>
</div>

<!-- ========================= CEK IN ========================= -->
<div id="view-checkin" class="container hidden">
  <button class="btn btn-ghost" onclick="show('home')">‚Üê Kembali</button>
  <h2>Form Cek-In</h2>

  <div id="ci_warn" class="warn hidden"></div>

  <!-- Data otomatis -->
  <div class="card">
    <div class="section-title">Data Otomatis (Sistem)</div>
    <div class="row">
      <div>
        <label>Tanggal</label>
        <input id="ci_tanggal" readonly />
      </div>
      <div>
        <label>Jam</label>
        <input id="ci_jam" readonly />
      </div>
    </div>

    <label>Nama Lokasi</label>
    <input id="ci_lokasi" readonly />
    <span id="ci_src" class="badge">Lokasi: -</span>

    <div class="row">
      <div>
        <label>Latitude</label>
        <input id="ci_lat" readonly />
      </div>
      <div>
        <label>Longitude</label>
        <input id="ci_lng" readonly />
      </div>
    </div>
  </div>

  <!-- Data diisi petugas -->
  <div class="card">
    <div class="section-title">Data Diisi Petugas</div>

    <label>Nomor Order</label>
    <select id="ci_order">
      <option value="">‚è≥ Memuat...</option>
    </select>

    <label>Nama Vaksinator</label>
    <input id="ci_nama" placeholder="Nama lengkap petugas" />

    <label>Kondisi Vaksin</label>
    <select id="ci_kondisi">
      <option value="">-- Pilih --</option>
      <option>Baik</option>
      <option>Perlu Pendinginan</option>
      <option>Rusak</option>
      <option>Thawing</option>
      <option>Tidak Thawing</option>
    </select>

    <label>Nomor Batch Vaksin</label>
    <div id="ci_batch_wrap"></div>
    <div class="btn-group">
      <button class="btn btn-ghost" type="button" onclick="addBatch()">‚ûï Tambah Batch</button>
      <button class="btn btn-ghost" type="button" onclick="resetBatches()">‚Ü∫ Reset Batch</button>
    </div>

    <label>Upload Foto (maks. 5)</label>
    <input type="file" id="ci_fotos" accept="image/*" multiple />
    <div class="hint">Pilih 1‚Äì5 foto. Bisa hapus per-foto (ikon √ó) atau hapus semua.</div>
    <div id="ci_fotos_preview" class="photos-preview"></div>
    <div class="btn-group">
      <button type="button" id="ci_fotos_clear" class="btn btn-danger">üóëÔ∏è Hapus Semua Foto</button>
    </div>

    <!-- TTD DIHAPUS pada CEK-IN -->

    <label>Catatan</label>
    <textarea id="ci_catatan" placeholder="Opsional"></textarea>

    <div class="btn-group">
      <button class="btn btn-primary" type="button" onclick="submitCI()">Kirim Cek-In</button>
      <button class="btn btn-ghost" type="button" onclick="resetForm('ci')">‚Ü∫ Reset Form</button>
    </div>
  </div>
</div>

<!-- ========================= CEK OUT ======================== -->
<div id="view-checkout" class="container hidden">
  <button class="btn btn-ghost" onclick="show('home')">‚Üê Kembali</button>
  <h2>Form Cek-Out</h2>

  <div id="co_warn" class="warn hidden"></div>

  <!-- Data otomatis -->
  <div class="card">
    <div class="section-title">Data Otomatis (Sistem)</div>
    <div class="row">
      <div>
        <label>Tanggal</label>
        <input id="co_tanggal" readonly />
      </div>
      <div>
        <label>Jam</label>
        <input id="co_jam" readonly />
      </div>
    </div>

    <label>Nama Lokasi</label>
    <input id="co_lokasi" readonly />
    <span id="co_src" class="badge">Lokasi: -</span>

    <div class="row">
      <div>
        <label>Latitude</label>
        <input id="co_lat" readonly />
      </div>
      <div>
        <label>Longitude</label>
        <input id="co_lng" readonly />
      </div>
    </div>
  </div>

  <!-- Data diisi petugas -->
  <div class="card">
    <div class="section-title">Data Diisi Petugas</div>

    <label>Nomor Order</label>
    <select id="co_order">
      <option value="">‚è≥ Memuat...</option>
    </select>

    <label>Nama Vaksinator</label>
    <input id="co_nama" placeholder="Nama lengkap petugas" />

    <label>No Kandang</label>
    <input id="co_kandang" placeholder="Contoh: A-12" />

    <label>Jumlah Ayam Tervaksin</label>
    <input type="number" id="co_ayam" min="0" step="1" placeholder="0" />

    <label>Jumlah Vaksin Terpakai</label>
    <input type="number" id="co_vaksin" min="0" step="1" placeholder="0" />

    <label>Upload Foto (maks. 5)</label>
    <input type="file" id="co_fotos" accept="image/*" multiple />
    <div class="hint">Pilih 1‚Äì5 foto. Bisa hapus per-foto (ikon √ó) atau hapus semua.</div>
    <div id="co_fotos_preview" class="photos-preview"></div>
    <div class="btn-group">
      <button type="button" id="co_fotos_clear" class="btn btn-danger">üóëÔ∏è Hapus Semua Foto</button>
    </div>

    <div class="sig-wrap">
      <div class="sig-toolbar">
        <div class="title">Tanda Tangan Digital (Petugas Farm)</div>
        <button type="button" class="btn btn-ghost" onclick="clearSignature('co')">Hapus TTD</button>
      </div>
      <canvas id="co_sig_canvas" class="sig"></canvas>
      <input type="hidden" id="co_signature_data" />
    </div>

    <label>Catatan</label>
    <textarea id="co_catatan" placeholder="Opsional"></textarea>

    <div class="btn-group">
      <button class="btn btn-primary" type="button" onclick="submitCO()">Kirim Cek-Out</button>
      <button class="btn btn-ghost" type="button" onclick="resetForm('co')">‚Ü∫ Reset Form</button>
    </div>
  </div>
</div>

<!-- ================= LOADING OVERLAY ================= -->
<div id="loading" class="hidden"
  style="
    position:fixed;
    inset:0;
    background:rgba(255,255,255,.85);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
    font-weight:600;
    font-size:18px;">
  ‚è≥ Memproses...
</div>

<script>
  /* ====== KONFIG FLOW ====== */
  // Pastikan URL di JS menggunakan '&' (bukan '&amp;')
  const FLOW_GET_ORDER_URL =
  "https://default08c67d278fe34663834968bc1ace2e.be.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/0b8ea542919749eeabb66e27e32c1b5a/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Ly_DAybOG8S6gwh03EPU-jGikDyD084xiN_-M-Kaa0I";

  // Endpoint submit (isi jika sudah ada Flow untuk submit)
  const FLOW_SUBMIT_CI_URL = "";
  const FLOW_SUBMIT_CO_URL = "";

  const MAX_PHOTOS = 5;
  const REQUIRE_SIGNATURE_CO = true; // TTD hanya diwajibkan pada Cek-Out

  const $ = (id)=>document.getElementById(id);

  function showLoading(msg){
    const el=$('loading');
    if(msg) el.textContent = msg;
    el.classList.remove('hidden');
  }
  function hideLoading(){
    const el=$('loading');
    el.classList.add('hidden');
    el.textContent = '‚è≥ Memproses...';
  }

  /* ====== VIEW NAV ====== */
  function show(v){
    $('view-home').classList.add('hidden');
    $('view-checkin').classList.add('hidden');
    $('view-checkout').classList.add('hidden');

    $('view-'+v).classList.remove('hidden');
    window.scrollTo({top:0,behavior:'instant'});

    if(v==='checkin'){
      init('ci');
      initBatches();
      loadOrders('ci_order');
      attachMultiPhotoHandler('ci_fotos','ci_fotos_preview','ci_fotos_clear');
    }
    if(v==='checkout'){
      init('co');
      loadOrders('co_order');
      initSignatureOnce('co'); // init signature hanya sekali
      attachMultiPhotoHandler('co_fotos','co_fotos_preview','co_fotos_clear');
    }
  }

  /* ====== INIT TANGGAL & JAM ====== */
  function init(p){
    const d=new Date();
    $(p+'_tanggal').value =
      d.toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});
    $(p+'_jam').value =
      d.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',hour12:false});
    loadLocation(p);
  }

  /* ====== LOKASI ====== */
  function simplifyAddress(a){
    const parts = (a||'').split(',');
    return parts.slice(1).join(',').trim() || (a||'');
  }

  async function loadLocation(p){
    const src=$(p+'_src');
    navigator.geolocation.getCurrentPosition(async pos=>{
      $(p+'_lat').value=pos.coords.latitude.toFixed(6);
      $(p+'_lng').value=pos.coords.longitude.toFixed(6);
      src.textContent='Lokasi: GPS';
      try{
        const r=await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`
        );
        const j=await r.json();
        if(j?.display_name){
          $(p+'_lokasi').value=simplifyAddress(j.display_name);
        }
      }catch(e){
        console.warn('Gagal reverse geocode', e);
      }
    }, async ()=>{
      try{
        const r=await fetch('https://ipapi.co/json/');
        const j=await r.json();
        $(p+'_lat').value=j.latitude ?? '';
        $(p+'_lng').value=j.longitude ?? '';
        $(p+'_lokasi').value=`${j.city ?? '-'}, ${j.region ?? '-'}, ${j.country_name ?? '-'}`;
        src.textContent='Lokasi: Perkiraan IP';
      }catch(e){
        console.warn('Gagal ambil lokasi via IP', e);
        src.textContent='Lokasi: Tidak tersedia';
      }
    });
  }

  /* ====== BATCHES (CEK-IN) ====== */
  function initBatches(){
    $('ci_batch_wrap').innerHTML='';
    addBatch();
  }
  function addBatch(){
    const wrap=$('ci_batch_wrap');
    const i=document.createElement('input');
    i.placeholder='Nomor Batch';
    i.style.marginBottom='8px';
    wrap.appendChild(i);
  }
  function resetBatches(){ initBatches(); }

  function getBatchValues(){
    const inputs = Array.from($('ci_batch_wrap').querySelectorAll('input'));
    return inputs.map(i=>i.value.trim()).filter(v=>v!=='');
  }

  /* ====== FOTO HANDLER (preview + hapus per-foto + revoke objectURL) ====== */
  const photoHandlers = {}; // per inputId: {urls:[], clear, render, removeAt}

  function attachMultiPhotoHandler(inputId, previewId, clearBtnId){
    const inp=$(inputId);
    const preview=$(previewId);
    const clearBtn = clearBtnId ? $(clearBtnId) : null;

    if(!photoHandlers[inputId]){
      photoHandlers[inputId] = { urls: [] };
    }
    const state = photoHandlers[inputId];

    function revokeAll(){
      (state.urls || []).forEach(u=>URL.revokeObjectURL(u));
      state.urls = [];
    }

    function syncLimit(){
      let files = Array.from(inp.files || []);
      if(files.length > MAX_PHOTOS){
        alert(`Maksimal ${MAX_PHOTOS} foto. Hanya ${MAX_PHOTOS} pertama yang digunakan.`);
        const dt = new DataTransfer();
        files.slice(0,MAX_PHOTOS).forEach(f=>dt.items.add(f));
        inp.files = dt.files;
        files = Array.from(inp.files);
      }
      return files;
    }

    function render(){
      const files = syncLimit();
      revokeAll();
      preview.innerHTML='';

      files.forEach((f, idx)=>{
        if(!f.type.startsWith('image/')) return;

        const item=document.createElement('div');
        item.className='photo-item';

        const img=document.createElement('img');
        img.alt=f.name;

        const url = URL.createObjectURL(f);
        state.urls.push(url);
        img.src=url;

        const del=document.createElement('button');
        del.className='photo-del';
        del.type='button';
        del.textContent='√ó';
        del.title='Hapus foto ini';
        del.onclick = ()=> removeAt(idx);

        item.appendChild(img);
        item.appendChild(del);
        preview.appendChild(item);
      });
    }

    function clearAll(){
      const dt = new DataTransfer();
      inp.files = dt.files;
      revokeAll();
      preview.innerHTML='';
    }

    function removeAt(idx){
      const files = Array.from(inp.files || []);
      const dt = new DataTransfer();
      files.forEach((f,i)=>{ if(i!==idx) dt.items.add(f); });
      inp.files = dt.files;
      render();
    }

    if(clearBtn){ clearBtn.onclick = clearAll; }
    inp.onchange = render;

    state.clear = clearAll;
    state.render = render;
    state.removeAt = removeAt;
  }

  function appendPhotos(fd, inputId){
    const files = Array.from($(inputId).files || []).slice(0,MAX_PHOTOS);
    files.forEach((f,idx)=> fd.append(`photos[${idx}]`, f, f.name));
  }

  /* ====== SIGNATURE PAD (CEK-OUT) - init sekali ====== */
  const sigPads = {}; // {co:{initialized, canvas, ctx, signed, clear}}

  function initSignatureOnce(prefix){
    if(sigPads[prefix]?.initialized) return;

    const canvas = $(prefix+'_sig_canvas');
    const hidden = $(prefix+'_signature_data');

    const pad = { initialized:true, canvas, ctx:null, signed:false, clear:null };
    sigPads[prefix] = pad;

    function setupCanvas(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();

      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);

      const ctx = canvas.getContext('2d');
      // gunakan skala untuk menggambar dengan koordinat CSS
      ctx.setTransform(ratio,0,0,ratio,0,0);

      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = '#0f172a';

      // background putih full (pakai ukuran canvas asli)
      ctx.save();
      ctx.setTransform(1,0,0,1,0,0);
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.restore();

      pad.ctx = ctx;
      return ctx;
    }

    const ctx = setupCanvas();
    let drawing=false, last={x:0,y:0};

    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      if(e.touches && e.touches.length){
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
      }
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function start(e){ e.preventDefault(); drawing=true; last=getPos(e); }
    function move(e){
      if(!drawing) return;
      e.preventDefault();
      const p=getPos(e);
      ctx.beginPath();
      ctx.moveTo(last.x,last.y);
      ctx.lineTo(p.x,p.y);
      ctx.stroke();
      last=p;
      pad.signed=true;
    }
    function end(){
      if(!drawing) return;
      drawing=false;
      if(pad.signed) hidden.value = canvas.toDataURL('image/png');
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('mouseleave', end);

    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    canvas.addEventListener('touchend', end);

    pad.clear = ()=>{
      const c=canvas;
      const cctx=pad.ctx;

      cctx.save();
      cctx.setTransform(1,0,0,1,0,0);
      cctx.clearRect(0,0,c.width,c.height);
      cctx.fillStyle='#fff';
      cctx.fillRect(0,0,c.width,c.height);
      cctx.restore();

      pad.signed=false;
      hidden.value='';
    };
  }

  function clearSignature(prefix){ sigPads[prefix]?.clear?.(); }

  function dataURLtoBlob(dataURL){
    const parts = dataURL.split(',');
    const mime = parts[0].match(/:(.*?);/)[1];
    const bstr = atob(parts[1]);
    let n=bstr.length;
    const u8=new Uint8Array(n);
    while(n--) u8[n]=bstr.charCodeAt(n);
    return new Blob([u8],{type:mime});
  }

  /* ====== LOAD ORDERS - sesuai output Flow Mas ====== */

async function loadOrders(selectId){
  console.log('loadOrders called:', selectId);

  const sel = $(selectId);
  sel.innerHTML = '<option value="">-- Pilih Nomor Order --</option>';

  const type = selectId.startsWith('ci') ? 'checkin' : 'checkout';

  try{
    showLoading('‚è≥ Mengambil data order...');

    const r = await fetch(FLOW_GET_ORDER_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain; charset=UTF-8',
        'Accept': 'application/json'
      },
      body: type
    });

    const raw = await r.text();
    console.log('[FLOW] HTTP:', r.status);
    console.log('[FLOW] RAW:', raw);

    if(!r.ok){
      throw new Error(`HTTP ${r.status} - ${raw.slice(0,300)}`);
    }

    // --- helper parse aman, termasuk parse-ulang jika hasil parse masih string JSON ---
    const safeJson = (x)=>{
      if(x == null) return null;
      if(typeof x === 'object') return x;
      if(typeof x !== 'string') return null;
      try {
        const p1 = JSON.parse(x);
        if(typeof p1 === 'string'){
          try { return JSON.parse(p1); } catch { return p1; }
        }
        return p1;
      } catch { return null; }
    };

    // 1) parse response utama
    let j = safeJson(raw);
    if(!j) throw new Error('Response tidak bisa diparse JSON.');

    // 2) beberapa flow membungkus: { statusCode, headers, body: ... }
    //    body bisa object ATAU string JSON
    if(j.body){
      const bodyParsed = safeJson(j.body) || j.body;
      // kalau bodyParsed object, pakai itu sebagai sumber utama
      if(typeof bodyParsed === 'object') j = { ...j, body: bodyParsed };
    }

    // --- cari list orders dari berbagai jalur ---
    let list =
      (Array.isArray(j?.body?.orders) ? j.body.orders : null) ||
      (Array.isArray(j?.orders) ? j.orders : null) ||
      (Array.isArray(j?.body) ? j.body : null) ||
      (Array.isArray(j?.value) ? j.value : null) ||
      [];

    console.log('[FLOW] parsed:', j);
    console.log('[FLOW] list length:', list.length);

    if(!Array.isArray(list) || list.length === 0){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '(Tidak ada data order / struktur response tidak sesuai)';
      sel.appendChild(opt);
      return;
    }

    // isi dropdown (sesuai output Mas: item punya Value)
    list.forEach(o=>{
      let val = '';

      if(typeof o === 'string'){
        val = o;
      }else{
        // output mas: { Name:"orderNumber", Value:"SPVaksin ... - 2026-01-00001\n" }
        val = (o?.Value ?? o?.value ?? o?.orderNumber ?? o?.OrderNumber ?? '').toString();
      }

      // rapikan newline/spasi
      val = val.replace(/\s+/g, ' ').trim();

      if(!val) return;

      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      sel.appendChild(opt);
    });

    // safety: kalau tidak ada yang ke-append
    if(sel.options.length <= 1){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '(Data ada, tapi field Value/orderNumber tidak ditemukan)';
      sel.appendChild(opt);
    }

  }catch(e){
    console.error('Gagal mengambil data order', e);
    alert('Gagal mengambil data order.\n\nDETAIL:\n' + (e?.message || e));
  }finally{
    hideLoading();
  }
}

  /* ====== SUBMIT (siap hook) ====== */
  async function sendFormData(url, formData){
    if(!url){
      // debug local: tidak mengirim kemana-mana
      console.log('[DEBUG payload submit]',
        ...Array.from(formData.entries()).map(([k,v]) =>
          [k, v instanceof File ? `File(${v.name}, ${v.type}, ${v.size})` : v]
        )
      );
      await new Promise(r=>setTimeout(r,400));
      return { ok:true };
    }
    return await fetch(url, { method:'POST', body: formData });
  }

  function submitCI(){
    const warn = $('ci_warn');
    warn.classList.add('hidden'); warn.textContent='';

    const order = $('ci_order').value;
    const nama = $('ci_nama').value.trim();
    const kondisi = $('ci_kondisi').value;
    const batches = getBatchValues();
    const fotos = $('ci_fotos').files;

    if(!order || !nama || !kondisi){
      warn.textContent='‚ö†Ô∏è Nomor Order, Nama Vaksinator, dan Kondisi wajib diisi.';
      warn.classList.remove('hidden'); return;
    }
    if(batches.length===0){
      warn.textContent='‚ö†Ô∏è Minimal 1 Nomor Batch diisi.';
      warn.classList.remove('hidden'); return;
    }
    if(!fotos || fotos.length===0){
      warn.textContent='‚ö†Ô∏è Wajib unggah minimal 1 foto (maksimal 5).';
      warn.classList.remove('hidden'); return;
    }
    if(fotos.length>MAX_PHOTOS){
      warn.textContent=`‚ö†Ô∏è Maksimal ${MAX_PHOTOS} foto.`;
      warn.classList.remove('hidden'); return;
    }

    const fd = new FormData();
    fd.append('formType','checkin');
    fd.append('orderNumber', order);
    fd.append('namaVaksinator', nama);
    fd.append('kondisiVaksin', kondisi);
    fd.append('tanggal', $('ci_tanggal').value);
    fd.append('jam', $('ci_jam').value);
    fd.append('lokasi', $('ci_lokasi').value);
    fd.append('latitude', $('ci_lat').value);
    fd.append('longitude', $('ci_lng').value);
    fd.append('catatan', $('ci_catatan').value || '');
    batches.forEach((b,i)=> fd.append(`batches[${i}]`, b));
    appendPhotos(fd, 'ci_fotos');

    (async ()=>{
      try{
        showLoading('‚è≥ Mengirim Cek-In...');
        const resp = await sendFormData(FLOW_SUBMIT_CI_URL, fd);
        hideLoading();
        if(resp.ok){
          alert('‚úÖ Cek-In berhasil');
          show('home');
        }else{
          alert('‚ùå Gagal submit Cek-In');
        }
      }catch(e){
        hideLoading();
        console.error(e);
        alert('‚ùå Terjadi kesalahan saat submit Cek-In');
      }
    })();
  }

  function submitCO(){
    const warn = $('co_warn');
    warn.classList.add('hidden'); warn.textContent='';

    const order = $('co_order').value;
    const nama = $('co_nama').value.trim();
    const kandang = $('co_kandang').value.trim();
    const ayam = $('co_ayam').value;
    const vaksin = $('co_vaksin').value;
    const fotos = $('co_fotos').files;
    const sigData = $('co_signature_data').value;

    if(!order || !nama || !kandang){
      warn.textContent='‚ö†Ô∏è Nomor Order, Nama Vaksinator, dan No Kandang wajib diisi.';
      warn.classList.remove('hidden'); return;
    }
    if(ayam==='' || Number(ayam)<0 || vaksin==='' || Number(vaksin)<0){
      warn.textContent='‚ö†Ô∏è Jumlah Ayam dan Vaksin harus diisi dengan angka ‚â• 0.';
      warn.classList.remove('hidden'); return;
    }
    if(!fotos || fotos.length===0){
      warn.textContent='‚ö†Ô∏è Wajib unggah minimal 1 foto (maksimal 5).';
      warn.classList.remove('hidden'); return;
    }
    if(fotos.length>MAX_PHOTOS){
      warn.textContent=`‚ö†Ô∏è Maksimal ${MAX_PHOTOS} foto.`;
      warn.classList.remove('hidden'); return;
    }
    if(REQUIRE_SIGNATURE_CO && !sigData){
      warn.textContent='‚ö†Ô∏è Tanda tangan digital wajib.';
      warn.classList.remove('hidden'); return;
    }

    const fd = new FormData();
    fd.append('formType','checkout');
    fd.append('orderNumber', order);
    fd.append('namaVaksinator', nama);
    fd.append('noKandang', kandang);
    fd.append('jumlahAyam', ayam);
    fd.append('jumlahVaksin', vaksin);
    fd.append('tanggal', $('co_tanggal').value);
    fd.append('jam', $('co_jam').value);
    fd.append('lokasi', $('co_lokasi').value);
    fd.append('latitude', $('co_lat').value);
    fd.append('longitude', $('co_lng').value);
    fd.append('catatan', $('co_catatan').value || '');
    appendPhotos(fd, 'co_fotos');

    if(sigData){
      fd.append('signature', dataURLtoBlob(sigData), 'signature_co.png');
    }

    (async ()=>{
      try{
        showLoading('‚è≥ Mengirim Cek-Out...');
        const resp = await sendFormData(FLOW_SUBMIT_CO_URL, fd);
        hideLoading();
        if(resp.ok){
          alert('‚úÖ Cek-Out berhasil');
          show('home');
        }else{
          alert('‚ùå Gagal submit Cek-Out');
        }
      }catch(e){
        hideLoading();
        console.error(e);
        alert('‚ùå Terjadi kesalahan saat submit Cek-Out');
      }
    })();
  }

  /* ====== RESET FORM ====== */
  function resetForm(prefix){
    const warnEl = $(prefix+'_warn');
    if(warnEl){ warnEl.classList.add('hidden'); warnEl.textContent=''; }

    const viewId = prefix==='ci' ? 'checkin' : 'checkout';
    const selOrder = $(prefix+'_order');
    if(selOrder) selOrder.selectedIndex = 0;

    const fields = Array.from(document.querySelectorAll(
      `#view-${viewId} input, #view-${viewId} textarea, #view-${viewId} select`
    ));

    fields.forEach(el=>{
      if(el.id.endsWith('_tanggal') || el.id.endsWith('_jam') || el.id.endsWith('_lokasi') || el.id.endsWith('_lat') || el.id.endsWith('_lng')) return;
      if(el.tagName==='SELECT'){
        if(el.id !== prefix+'_order') el.selectedIndex = 0;
      }else if(el.type==='hidden'){
        el.value='';
      }else if(el.type==='file'){
        // clear via handler
      }else{
        el.value='';
      }
    });

    if(prefix==='ci') initBatches();

    const photoId = prefix+'_fotos';
    if(photoHandlers[photoId]?.clear) photoHandlers[photoId].clear();

    if(prefix==='co') clearSignature('co');

    init(prefix); // refresh tanggal/jam/lokasi
  }
</script>

</body>
</html>
``
